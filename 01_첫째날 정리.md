# 사용할 자바스크립트 주요 문법
- Classes
- Arrow functions
- Spread operator
- Let and const
- Proxy
- Default parameters
- Array.from()

## 세팅
- 상수(const)를 통해 보드 행렬, 블록 사이즈 정의
- canvas로 그래픽 표현
- html, css는 걍 복붙

```javascript
//*** constants.js
'use strict';

const COLS = 10;
const ROWS = 20;
const BLOCK_SIZE = 30;

//*** main.js
const canvas = document.getElementById('board');
const ctx = canvas.getContext('2d');

// 캔버스 크기 계산
ctx.canvas.width = COLS * BLOCK_SIZE;
ctx.canvas.height = ROWS * BLOCK_SIZE;

// 블록 크기 변경: 매번 BLOCK_SIZE로 계산할 필요가 없이 블록의 크기를 1로 취급
ctx.scale(BLOCK_SIZE, BLOCK_SIZE);
```

## 테트리스 보드: Classes, Array.from()

- 테트리스 보드는 셀들로 구성되어 있고, 각 셀은 채워져 있거나 그렇지 않을 수 있다.
- 비어있는 셀은 0으로 표시하고 색상은 1-7을 사용해 표시하며  초기 보드의 모든 셀은 0 이다.
- 게임 보드는 행렬로 이뤄져있고 행을 나타내기 위해 숫자형의 배열을 사용한다.

```javascript
//*** board.js
class Board {
  grid;
  // 보드 초기화
  reset() {
    this.grid = this.getEmptyBoard();
  }
  // 행(20)만큼 length를 가진 객체를 배열로 만들껀데 열(10)을 0으로 배열로 만들어라
  getEmptyBoard() {
    return Array.from(
      {length: ROWS}, () => Array(COLS).fill(0)
    );
  }
}

//*** main.js
let board = new Board();

function play() {
  board.reset(); // 보드판 초기화
  console.table(board.grid);
}
```

## 테트로미노
- 테트리스 한조각은 4개 블록으로 구성되어 있다.
- 하나의 테트로미노는 I, J, L, O, S, T, Z 모양을 띄고 있다.
- J, L, T는 평평한 쪽을 먼저 수평으로 생성한다.
- 가령 J 모양은 아래의 행렬구조를 띄고 있다.

```javascript
let j = [
  [2, 0, 0],
  [2, 2, 2],
  [0, 0, 0];
];
```

- 보드에 각 테트로미노를 그릴 수 있도록 캔버스 컨텍스트를 참조하는 Piece 클래스를 생성 한다.

```javascript
//*** piece.js
class Piece {
  x;
  y;
  color;
  shape;
  ctx;

  constructor(ctx) {
    this.ctx = ctx;
    this.spawn();
  }

  spawn() {
    this.color = 'blue';
    this.shape = [
      [2, 0, 0],
      [2, 2, 2],
      [0, 0, 0]
    ];
    // 시작 위치
    this.x = 3;
    this.y = 0;
  }

  draw() {
    this.ctx.fillStyle=this.color;
    // shape의 셀을 순회하면서 0보다 크면 색을 칠한다.
    this.shape.forEach((row, y) => {
      row.forEach((value, x) => {
        if(value > 0) this.ctx.fillRect(this.x + x, this.y + y, 1, 1);
      });
    });
  }

}
```

- 버튼을 클릭하면 테트로미노 그리는 기능 추가한다.

```javascript
//*** main.js
let board = new Board();

function play() {
  board.reset(); // 보드판 초기화
  console.table(board.grid);

  let piece = new Piece(ctx);
  piece.draw(); // 테트로미노 그리기

  board.piece=piece;
}
```

## 키보드 입력 : Spread operator, Let and const
- 보드 위에서 위치를 변경하기 위해 현재 조각의 x 또는 y 속성값을 변경하는 메서드 추가

```javascript
//*** piece.js

  // 키보드로 움직이기
  move(p) {
    this.x = p.x;
    this.y = p.y;
  }

```

- 키들을 키 코드 값으로 매핑한다. 열거형(enum)처럼 사용하기 위해 객체를 프리징한다.

```javascript
//*** constants.js
// 키코드로 키매핑
const KEY = {
  LEFT: 37,
  RIGHT: 39,
  DOWN: 40
}
// 불변으로 만드는 값은 1레벨에서만 동작한다 -> 객체 안에 하위의 객체는 불변하게 만들 수 없다.
Object.freeze(KEY);
```

- 키보드 이벤트를 감지해서, 왼쪽, 오른쪽, 아래 방향키를 누르면 조각이 움직이게 만든다.

```javascript
//*** main.js

moves = {
  [KEY.LEFT]: p => ({...p, x: p.x - 1}),
  [KEY.RIGHT]: p => ({...p, x: p.x + 1}),
  [KEY.DOWN]: p => ({...p, y: p.y + 1}),
}

document.addEventListener('keydown', event => {
  if(moves[event.keyCode]) {
    event.preventDefault();

    // 조각의 새 상태를 얻음
    let p = moves[event.keyCode](board.piece);
    if(board.valid(p)) {
      // 이동 가능한 조각을 이동
      board.piece.move(p);
      // 그리기 전에 이전 좌표를 삭제
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      // 테트로미노 그림
      board.piece.draw();
    }
  }
});
```

## 충돌 감지
- 먼저 아래와 같은 충돌을 확인 후 안전한 경우에만 테트로미노를 움직인다.
  - 바닥에 닿는다.
  - 왼쪽 또는 오른쪽 벽으로 이동한다.
  - 보드 안에 다른 블록과 부딪친다.
  - 회전하는 중에 벽 또는 다른 블록과 부딪친다.

- 테트로미노를 움직이기 전에 이동한 위치가 유효한지 확인하는 로직을 추가한다. 충돌을 감지하기 위해, 테트로미노가 새롭게 차지할 그리드의 모든 공간을 순회한다.

```javascript
//*** board.js

  insideWalls(x) {
    return x >= 0 && x < COLS;
  }

  aboveFloor(y) {
    return y <= ROWS;
  }

  notOccupied(x, y) {
    return this.grid[y] && this.grid[y][x] === 0;
  }

  valid(p) {
    // 조각의 모든 블록 좌표를 계산하고 유효한 위치인지 확인한다
    return p.shape.every((row, dy) => {
      return row.every((value, dx) => {
        let x = p.x + dx;
        let y = p.y + dy;
        return (
          value === 0 ||
          (this.insideWalls(x) && this.aboveFloor(y) && this.notOccupied(x, y))
        );
      });
    });
  }

```

## 하드 드롭(hard drop)을 추가
- 스페이스 바를 누르면 테트로미노가 무언가와 충돌할 때까지 떨어진다.

```javascript
//*** constants.js
// 키코드로 키매핑
const KEY = {
  // ... 기존 코드
  SPACE: 32,
}
```

```javascript
//*** main.js
moves = {
  // ... 기존 코드
  [KEY.SPACE]: p => ({ ...p, y: p.y + 1 }),
}
document.addEventListener('keydown', event => {
  if(moves[event.keyCode]) {
    event.preventDefault();
    
    // 조각의 새 상태를 얻음
    let p = moves[event.keyCode](board.piece);

    // 스페이스 누를 경우 하드 드롭
    if (event.keyCode === KEY.SPACE) {
      while (board.valid(p)) {
        board.piece.move(p);   
        p = moves[KEY.DOWN](board.piece);
      }
    }
    
    if(board.valid(p)) {
      // 기존 코드
    }
  }
});
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```

```javascript
//*** 
```
